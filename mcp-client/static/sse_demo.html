<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCPæµå¼ä»»åŠ¡æ‰§è¡Œæ¼”ç¤º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .event-log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.running {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .progress {
            margin: 10px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .event-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .event-type {
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .event-type.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>ğŸŒŠ MCPæµå¼ä»»åŠ¡æ‰§è¡Œæ¼”ç¤º</h1>
    
    <div class="container">
        <h2>ä»»åŠ¡é…ç½®</h2>
        <form id="taskForm">
            <div class="form-group">
                <label for="serverUrl">MCPå®¢æˆ·ç«¯URL:</label>
                <input type="text" id="serverUrl" value="http://localhost:8080">
            </div>
            
            <div class="form-group">
                <label for="vmId">VM ID:</label>
                <input type="text" id="vmId" value="demo_vm">
            </div>
            
            <div class="form-group">
                <label for="sessionId">Session ID:</label>
                <input type="text" id="sessionId" value="demo_session">
            </div>
            
            <div class="form-group">
                <label for="mcpServerName">MCPæœåŠ¡å™¨åç§°:</label>
                <select id="mcpServerName">
                    <option value="filesystem">filesystem</option>
                    <option value="audio_slicer">audio_slicer</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="taskDescription">ä»»åŠ¡æè¿°:</label>
                <textarea id="taskDescription" rows="3">åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯</textarea>
            </div>
            
            <div class="form-group">
                <label for="context">ä»»åŠ¡ä¸Šä¸‹æ–‡ (å¯é€‰):</label>
                <input type="text" id="context" placeholder="æ¼”ç¤ºæµå¼è°ƒç”¨åŠŸèƒ½">
            </div>
            
            <button type="submit" id="startBtn">ğŸš€ å¼€å§‹æµå¼æ‰§è¡Œ</button>
            <button type="button" id="stopBtn" disabled>â¹ï¸ åœæ­¢è¿æ¥</button>
            <button type="button" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </form>
    </div>
    
    <div class="container">
        <h2>è¿æ¥çŠ¶æ€</h2>
        <div id="status" class="status disconnected">æœªè¿æ¥</div>
        
        <div class="progress">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText">ç­‰å¾…å¼€å§‹...</div>
        </div>
        
        <div class="event-types">
            <div class="event-type" id="event-start">å¼€å§‹äº‹ä»¶ (0)</div>
            <div class="event-type" id="event-tool_start">å·¥å…·å¼€å§‹ (0)</div>
            <div class="event-type" id="event-tool_result">å·¥å…·ç»“æœ (0)</div>
            <div class="event-type" id="event-progress">è¿›åº¦æ›´æ–° (0)</div>
            <div class="event-type" id="event-complete">å®Œæˆäº‹ä»¶ (0)</div>
            <div class="event-type" id="event-error">é”™è¯¯äº‹ä»¶ (0)</div>
        </div>
    </div>
    
    <div class="container">
        <h2>å®æ—¶æ—¥å¿—</h2>
        <div id="eventLog" class="event-log">ç­‰å¾…ä»»åŠ¡æ‰§è¡Œ...\n</div>
    </div>

    <script>
        let eventSource = null;
        let eventCounts = {
            'start': 0,
            'tool_start': 0,
            'tool_result': 0,
            'progress': 0,
            'complete': 0,
            'error': 0
        };

        const elements = {
            form: document.getElementById('taskForm'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            clearBtn: document.getElementById('clearBtn'),
            status: document.getElementById('status'),
            eventLog: document.getElementById('eventLog'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText')
        };

        // è¡¨å•æäº¤å¤„ç†
        elements.form.addEventListener('submit', function(e) {
            e.preventDefault();
            startStreamingTask();
        });

        // åœæ­¢æŒ‰é’®å¤„ç†
        elements.stopBtn.addEventListener('click', function() {
            stopStreaming();
        });

        // æ¸…ç©ºæ—¥å¿—æŒ‰é’®å¤„ç†
        elements.clearBtn.addEventListener('click', function() {
            elements.eventLog.textContent = '';
            resetEventCounts();
        });

        function startStreamingTask() {
            // è·å–è¡¨å•æ•°æ®
            const formData = {
                vm_id: document.getElementById('vmId').value,
                session_id: document.getElementById('sessionId').value,
                mcp_server_name: document.getElementById('mcpServerName').value,
                task_description: document.getElementById('taskDescription').value,
                context: document.getElementById('context').value || undefined
            };

            const serverUrl = document.getElementById('serverUrl').value;

            // é¦–å…ˆå‘é€POSTè¯·æ±‚å¯åŠ¨ä»»åŠ¡
            fetch(`${serverUrl}/tasks/execute-stream`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // åˆ›å»ºEventSourceè¿æ¥åˆ°æµå¼å“åº”
                const reader = response.body.getReader();
                startSSEConnection(reader);
            })
            .catch(error => {
                logEvent('âŒ å¯åŠ¨ä»»åŠ¡å¤±è´¥: ' + error.message);
                updateStatus('disconnected', 'è¿æ¥å¤±è´¥: ' + error.message);
            });
        }

        function startSSEConnection(reader) {
            updateStatus('connected', 'å·²è¿æ¥ - ä»»åŠ¡æ‰§è¡Œä¸­...');
            elements.startBtn.disabled = true;
            elements.stopBtn.disabled = false;

            function readStream() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        stopStreaming();
                        return;
                    }

                    // è§£æSSEæ•°æ®
                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');
                    
                    let currentEvent = {};
                    
                    for (const line of lines) {
                        if (line.startsWith('event:')) {
                            currentEvent.event = line.substring(6).trim();
                        } else if (line.startsWith('data:')) {
                            currentEvent.data = line.substring(5).trim();
                        } else if (line.trim() === '' && currentEvent.data) {
                            // å¤„ç†å®Œæ•´çš„äº‹ä»¶
                            handleSSEEvent(currentEvent);
                            currentEvent = {};
                        }
                    }

                    // ç»§ç»­è¯»å–
                    readStream();
                }).catch(error => {
                    logEvent('âŒ è¯»å–æµæ•°æ®å¤±è´¥: ' + error.message);
                    stopStreaming();
                });
            }

            readStream();
        }

        function handleSSEEvent(event) {
            try {
                const eventData = JSON.parse(event.data);
                const eventType = eventData.type;
                const data = eventData.data;

                // æ›´æ–°äº‹ä»¶è®¡æ•°
                if (eventCounts.hasOwnProperty(eventType)) {
                    eventCounts[eventType]++;
                    updateEventCount(eventType, eventCounts[eventType]);
                }

                // å¤„ç†ä¸åŒç±»å‹çš„äº‹ä»¶
                switch (eventType) {
                    case 'start':
                        handleStartEvent(data);
                        break;
                    case 'tool_start':
                        handleToolStartEvent(data);
                        break;
                    case 'tool_result':
                        handleToolResultEvent(data);
                        break;
                    case 'progress':
                        handleProgressEvent(data);
                        break;
                    case 'complete':
                        handleCompleteEvent(data);
                        break;
                    case 'error':
                        handleErrorEvent(data);
                        break;
                }
            } catch (error) {
                logEvent('âš ï¸ è§£æäº‹ä»¶æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        function handleStartEvent(data) {
            const taskId = data.task_id;
            const taskDesc = data.task_description;
            logEvent(`ğŸš€ ä»»åŠ¡å¼€å§‹: ${taskDesc.substring(0, 50)}...`);
            logEvent(`ğŸ“ ä»»åŠ¡ID: ${taskId}`);
        }

        function handleToolStartEvent(data) {
            const stepNumber = data.step_number;
            const toolName = data.tool_name;
            const serverName = data.server_name;
            
            logEvent(`ğŸ”§ æ­¥éª¤ ${stepNumber}: å¼€å§‹æ‰§è¡Œå·¥å…·`);
            logEvent(`   ğŸ› ï¸  å·¥å…·: ${toolName}`);
            logEvent(`   ğŸ“¡ æœåŠ¡å™¨: ${serverName}`);
            
            if (data.reasoning) {
                logEvent(`   ğŸ’­ æ¨ç†: ${data.reasoning}`);
            }
        }

        function handleToolResultEvent(data) {
            const stepNumber = data.step_number;
            const toolName = data.tool_name;
            const status = data.status;
            const executionTime = data.execution_time;
            
            const statusEmoji = status === 'success' ? 'âœ…' : 'âŒ';
            logEvent(`${statusEmoji} æ­¥éª¤ ${stepNumber}: å·¥å…·æ‰§è¡Œå®Œæˆ`);
            logEvent(`   ğŸ› ï¸  å·¥å…·: ${toolName}`);
            logEvent(`   â±ï¸  æ—¶é—´: ${executionTime.toFixed(2)}ç§’`);
            
            if (data.result) {
                const resultPreview = JSON.stringify(data.result).substring(0, 100);
                logEvent(`   ğŸ“„ ç»“æœ: ${resultPreview}...`);
            }
        }

        function handleProgressEvent(data) {
            const currentStep = data.current_step;
            const totalSteps = data.total_steps;
            const percentage = data.completion_percentage;
            
            updateProgress(percentage);
            logEvent(`ğŸ“Š è¿›åº¦: ${currentStep}/${totalSteps} (${percentage}%)`);
        }

        function handleCompleteEvent(data) {
            const success = data.success;
            const executionTime = data.execution_time;
            const totalSteps = data.total_steps;
            const successfulSteps = data.successful_steps;
            
            logEvent(`ğŸ¯ ä»»åŠ¡å®Œæˆ!`);
            logEvent(`   âœ… çŠ¶æ€: ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
            logEvent(`   â±ï¸  æ€»æ—¶é—´: ${executionTime.toFixed(2)}ç§’`);
            logEvent(`   ğŸ“Š ç»Ÿè®¡: ${successfulSteps}/${totalSteps} æ­¥éª¤æˆåŠŸ`);
            
            if (data.new_files && Object.keys(data.new_files).length > 0) {
                logEvent(`   ğŸ“ ç”Ÿæˆæ–‡ä»¶:`);
                for (const [path, desc] of Object.entries(data.new_files)) {
                    logEvent(`      ğŸ“„ ${path}: ${desc}`);
                }
            }
            
            updateProgress(100);
            updateStatus('disconnected', 'ä»»åŠ¡å®Œæˆ');
            stopStreaming();
        }

        function handleErrorEvent(data) {
            const errorMessage = data.error_message;
            const errorType = data.error_type;
            
            logEvent(`âŒ æ‰§è¡Œé”™è¯¯:`);
            logEvent(`   ğŸš¨ ç±»å‹: ${errorType}`);
            logEvent(`   ğŸ“ ä¿¡æ¯: ${errorMessage}`);
            
            updateStatus('disconnected', 'æ‰§è¡Œå¤±è´¥: ' + errorMessage);
            stopStreaming();
        }

        function stopStreaming() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            
            if (elements.status.textContent.includes('æ‰§è¡Œä¸­')) {
                updateStatus('disconnected', 'è¿æ¥å·²åœæ­¢');
            }
        }

        function logEvent(message) {
            const timestamp = new Date().toLocaleTimeString();
            elements.eventLog.textContent += `[${timestamp}] ${message}\n`;
            elements.eventLog.scrollTop = elements.eventLog.scrollHeight;
        }

        function updateStatus(type, message) {
            elements.status.className = `status ${type}`;
            elements.status.textContent = message;
        }

        function updateProgress(percentage) {
            elements.progressFill.style.width = percentage + '%';
            elements.progressText.textContent = `è¿›åº¦: ${percentage}%`;
        }

        function updateEventCount(eventType, count) {
            const element = document.getElementById(`event-${eventType}`);
            if (element) {
                const text = element.textContent.replace(/\(\d+\)$/, `(${count})`);
                element.textContent = text;
                
                // ä¸´æ—¶é«˜äº®
                element.classList.add('active');
                setTimeout(() => element.classList.remove('active'), 500);
            }
        }

        function resetEventCounts() {
            for (const eventType in eventCounts) {
                eventCounts[eventType] = 0;
                updateEventCount(eventType, 0);
            }
            updateProgress(0);
        }
    </script>
</body>
</html>